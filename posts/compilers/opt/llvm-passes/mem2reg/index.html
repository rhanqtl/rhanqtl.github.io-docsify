<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.111.3">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>理解 mem2reg | rhanqtl</title>
<meta name="description" content=" \-">
<meta property="og:title" content="理解 mem2reg" />
<meta property="og:description" content="
\-

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/compilers/opt/llvm-passes/mem2reg/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-07T08:03:18+08:00" />
<meta property="article:modified_time" content="2023-03-07T08:03:18+08:00" /><meta property="og:site_name" content="rhanqtl" />
<meta itemprop="name" content="理解 mem2reg">
<meta itemprop="description" content="
\-

"><meta itemprop="datePublished" content="2023-03-07T08:03:18+08:00" />
<meta itemprop="dateModified" content="2023-03-07T08:03:18+08:00" />
<meta itemprop="wordCount" content="2426">
<meta itemprop="keywords" content="编译器,编译优化,LLVM," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="理解 mem2reg"/>
<meta name="twitter:description" content="
\-

"/>




<link rel="preload" href="/scss/main.min.bb1f3a37154c4661ae02d3cb1a733edd8005db70f626370ca004c689a63ab7d4.css" as="style">
<link href="/scss/main.min.bb1f3a37154c4661ae02d3cb1a733edd8005db70f626370ca004c689a63ab7d4.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page td-blog">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">rhanqtl</span></a>
  <div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link active" href="/posts/"><span class="active">原创博文</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="/about/"><span>个人简历</span></a>
      </li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    
  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-posts-li">
  <a href="/posts/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-posts"><span class="">原创博文</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-postsc-notes-li">
  <a href="/posts/c&#43;&#43;-notes/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-postsc-notes"><span class="">C&#43;&#43; 程序设计笔记</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postsc-notesxx-c11-features-li">
  <a href="/posts/c&#43;&#43;-notes/xx-c&#43;&#43;11-features/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postsc-notesxx-c11-features"><span class="">C&#43;&#43;11 新特性笔记</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-poststools-li">
  <a href="/posts/tools/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-poststools"><span class="">工具</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-poststoolscommand-line-roadmap-li">
  <a href="/posts/tools/command-line-roadmap/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-poststoolscommand-line-roadmap"><span class="">Linux 命令行操作学习路线图</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-poststoolsmigrating-from-coder-to-docsy-li">
  <a href="/posts/tools/migrating-from-coder-to-docsy/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-poststoolsmigrating-from-coder-to-docsy"><span class="">博客主题迁移：从 Coder 到 Docsy</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-poststoolsvscode-shortcut-cheatsheet-li">
  <a href="/posts/tools/vscode-shortcut-cheatsheet/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-poststoolsvscode-shortcut-cheatsheet"><span class="">VS Code 快捷键速查表</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-poststoolsgit-cheatsheet-li">
  <a href="/posts/tools/git-cheatsheet/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-poststoolsgit-cheatsheet"><span class="">Git 不常用命令速查（持续更新）</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-poststoolsc-dev-setup-with-vscode-li">
  <a href="/posts/tools/c&#43;&#43;-dev-setup-with-vscode/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-poststoolsc-dev-setup-with-vscode"><span class="">Visual Studio Code C/C&#43;&#43; 开发环境搭建</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-postscompilers-li">
  <a href="/posts/compilers/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-postscompilers"><span class="">编译技术</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postscompilersssa-construction-li">
  <a href="/posts/compilers/ssa-construction/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postscompilersssa-construction"><span class="">构造 SSA 形式</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postscompilersoptllvm-passeswriting-an-llvm-pass-li">
  <a href="/posts/compilers/opt/llvm-passes/writing-an-llvm-pass/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postscompilersoptllvm-passeswriting-an-llvm-pass"><span class="">实现一个 LLVM Pass</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-postscompilersoptllvm-passesmem2reg-li">
  <a href="/posts/compilers/opt/llvm-passes/mem2reg/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-postscompilersoptllvm-passesmem2reg"><span class="td-sidebar-nav-active-item">理解 mem2reg</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postscompilerstipsconstruct-lists-in-bison-li">
  <a href="/posts/compilers/tips/construct-lists-in-bison/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postscompilerstipsconstruct-lists-in-bison"><span class="">在 Bison 中如何构造列表</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postscompilerstipslexical-tie-ins-li">
  <a href="/posts/compilers/tips/lexical-tie-ins/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postscompilerstipslexical-tie-ins"><span class="">Bison 小技巧：tie-in</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postscompilersbuild-your-own-programming-language01-flex-bison-intro-li">
  <a href="/posts/compilers/build-your-own-programming-language/01-flex-bison-intro/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postscompilersbuild-your-own-programming-language01-flex-bison-intro"><span class="">用 Flex 和 Bison 实现一个计算器</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-postsdesign-patterns-li">
  <a href="/posts/design-patterns/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-postsdesign-patterns"><span class="">设计模式</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postsdesign-patternsvisitor-li">
  <a href="/posts/design-patterns/visitor/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postsdesign-patternsvisitor"><span class="">Visitor 模式</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postsgolang-and-duck-typing-li">
  <a href="/posts/golang-and-duck-typing/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postsgolang-and-duck-typing"><span class="">Go 和 Duck Typing</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postssieve-of-eratosthenes-li">
  <a href="/posts/sieve-of-eratosthenes/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postssieve-of-eratosthenes"><span class="">埃氏筛法及其实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postshow-to-launch-apps-from-web-browsers-li">
  <a href="/posts/how-to-launch-apps-from-web-browsers/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postshow-to-launch-apps-from-web-browsers"><span class="">如何从浏览器启动应用程序</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postsoj-solutionsleetcode640-li">
  <a href="/posts/oj-solutions/leetcode/640/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postsoj-solutionsleetcode640"><span class="">LeetCode 640. 求解方程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postsgolang-http-pattern-matching-rule-and-gorilla-li">
  <a href="/posts/golang-http-pattern-matching-rule-and-gorilla/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postsgolang-http-pattern-matching-rule-and-gorilla"><span class="">Go 标准库 net/http 模式匹配规则与 gorilla/mux</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-postsdavid-in-v2ray-core-source-code-li">
  <a href="/posts/david-in-v2ray-core-source-code/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-postsdavid-in-v2ray-core-source-code"><span class="">v2ray-core 源码中的大卫像</span></a>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">

</div>

            
            

	
		



  
  

	
		



  
  
    <div class="taxonomy taxonomy-terms-cloud taxo-tags">
      
        <h5 class="taxonomy-title">Tags</h5>
      
      <ul class="taxonomy-terms">
        
          <li><a class="taxonomy-term" href="/tags/bison/" data-taxonomy-term="bison"><span class="taxonomy-label">Bison</span><span class="taxonomy-count">3</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/c/c&#43;&#43;/" data-taxonomy-term="c/c&#43;&#43;"><span class="taxonomy-label">c/c&#43;&#43;</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/design-pattern/" data-taxonomy-term="design-pattern"><span class="taxonomy-label">Design Pattern</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/flex/" data-taxonomy-term="flex"><span class="taxonomy-label">Flex</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/git/" data-taxonomy-term="git"><span class="taxonomy-label">Git</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/golang/" data-taxonomy-term="golang"><span class="taxonomy-label">golang</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/hugo/" data-taxonomy-term="hugo"><span class="taxonomy-label">Hugo</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/lex/" data-taxonomy-term="lex"><span class="taxonomy-label">Lex</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/llvm/" data-taxonomy-term="llvm"><span class="taxonomy-label">LLVM</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/ssa/" data-taxonomy-term="ssa"><span class="taxonomy-label">SSA</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/type-system/" data-taxonomy-term="type-system"><span class="taxonomy-label">type-system</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/vs-code/" data-taxonomy-term="vs-code"><span class="taxonomy-label">VS Code</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/yacc/" data-taxonomy-term="yacc"><span class="taxonomy-label">Yacc</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/%E5%B7%A5%E5%85%B7%E9%93%BE/" data-taxonomy-term="%E5%B7%A5%E5%85%B7%E9%93%BE"><span class="taxonomy-label">工具链</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" data-taxonomy-term="%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7"><span class="taxonomy-label">开发工具</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96/" data-taxonomy-term="%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96"><span class="taxonomy-label">编译优化</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" data-taxonomy-term="%E7%BC%96%E8%AF%91%E5%99%A8"><span class="taxonomy-label">编译器</span><span class="taxonomy-count">6</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" data-taxonomy-term="%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="taxonomy-label">设计模式</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/" data-taxonomy-term="%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="taxonomy-label">静态分析</span><span class="taxonomy-count">1</span></a></li>
        
      </ul>
    </div>
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role="main">
            <a class="td-rss-button" title="RSS" href="/posts/compilers/index.xml" target="_blank" rel="noopener">
              <i class="fa-solid fa-rss" aria-hidden="true"></i>
            </a>
            
<div class="td-content">
	<h1>理解 mem2reg</h1>
	
	<div class="td-byline mb-4">
		
		<time datetime="2023-03-07" class="text-muted">Tuesday, March 07, 2023</time>
	</div>
	<header class="article-meta">
		

  
    


  
    


<div class="taxonomy taxonomy-terms-article taxo-tags">
  <h5 class="taxonomy-title">Tags:</h5>
  <ul class="taxonomy-terms">
    
      <li><a class="taxonomy-term" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" data-taxonomy-term="%E7%BC%96%E8%AF%91%E5%99%A8"><span class="taxonomy-label">编译器</span></a></li>
    
      <li><a class="taxonomy-term" href="/tags/%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96/" data-taxonomy-term="%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96"><span class="taxonomy-label">编译优化</span></a></li>
    
      <li><a class="taxonomy-term" href="/tags/llvm/" data-taxonomy-term="llvm"><span class="taxonomy-label">LLVM</span></a></li>
    
  </ul>
</div>

  

		
			<p class="reading-time"><i class="fa-solid fa-clock" aria-hidden="true"></i>&nbsp; 12 分钟阅读 &nbsp;</p>

		
	</header>
	<div class="sect1">
<h2 id="sec:background">背景</h2>
<div class="sectionbody">
<div class="paragraph">
<p>为了应对栈变量，LLVM 引入了 <a href="https://llvm.org/docs/LangRef.html#alloca-instruction:">alloca</a> 指令，以 C 语言为例，前端可以简单地将每个局部变量映射到一个 alloca 指令。然而，有些 alloca 指令其实是不必要的，不过让前端来负责简化它们会增加很多难度，因此 LLVM 引入了一个称为“<a href="https://llvm.org/docs/Passes.html#mem2reg-promote-memory-to-register">mem2reg</a>”的 pass，用于自动地将 alloca 变量提升为寄存器变量。</p>
</div>
<div class="paragraph">
<p>本文旨在以 mem2reg 为切入点深入学习 LLVM。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec:experiment">实验</h2>
<div class="sectionbody">
<div class="paragraph">
<p>为了看看 mem2reg 的效果，我们可以来尝试一些例子</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>编译命令为 <code>clang -S -emit-llvm -Xclang -disable-O0-optnone -fno-discard-value-names <em>/path/to/src</em></code>，其中，<code>-disable-O0-optnone</code> 是为了禁止 clang 在优化级别为 <code>-O0</code> 时给函数加上 <code>optnone</code> 属性，这个属性会让 PassManager 跳过可选的优化（包括 mem2reg），参见 <a href="#bib:opt-no-effect">[1]</a>；<code>-fno-discard-value-names</code> 是为了保留变量的名字，否则 LLVM IR 中所有的变量都会变成匿名的<a href="#bib:llvm-langref">[4]</a>，不便于阅读。</p>
</div>
<div class="paragraph">
<p>优化命令为 <code>opt -passes=mem2reg -S <em>/path/to/ll-file</em> [ &gt; <em>/path/to/opt-result</em> ]</code></p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_仅包含一条语句">仅包含一条语句</h3>
<div class="paragraph">
<p>一种情况是只有参数，没有局部变量。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c"><span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">foo</span><span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">x</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="background-color: #f8f8f8">printf</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#34;x = %d</span><span style="color: #d14">\n</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">x</span><span style="background-color: #f8f8f8">);</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>生成的 LLVM IR 和优化后的对比如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="llvm"><span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #008080">@foo</span><span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>                                   <span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #008080">@foo</span><span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
<span style="color: #990000;font-weight: bold">entry:</span>                                                       <span style="color: #990000;font-weight: bold">entry:</span>
  <span style="color: #008080">%x.addr</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">alloca</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>                           <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%x.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>                      <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%0</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">load</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%x.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>                     <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%call</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">call</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">ptr</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">...)</span> <span style="color: #008080">@printf</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">@.str</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%0</span><span style="background-color: #f8f8f8">)</span>  <span style="color: #a61717;background-color: #e3d2d2">|</span>    <span style="color: #008080">%call</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">call</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">ptr</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">...)</span> <span style="color: #008080">@printf</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">@.str</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">void</span>                                                     <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">void</span>
<span style="background-color: #f8f8f8">}</span>                                                            <span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>本来要 store/load 一次 <code>%x</code> 用匿名中间结果作为 printf 实参，mem2reg 替换成了 <code>%x</code>。可以想见多个参数应该也是相同的处理。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c"><span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">foo</span><span style="background-color: #f8f8f8">()</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">x</span><span style="color: #000000;font-weight: bold">++</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>对比：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="llvm"><span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #008080">@foo</span><span style="background-color: #f8f8f8">()</span> <span style="background-color: #f8f8f8">{</span>                  <span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #008080">@foo</span><span style="background-color: #f8f8f8">()</span> <span style="background-color: #f8f8f8">{</span>
<span style="color: #990000;font-weight: bold">entry:</span>                                <span style="color: #990000;font-weight: bold">entry:</span>
  <span style="color: #008080">%x</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">alloca</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>         <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>    <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%0</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">load</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>   <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%inc</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">add</span> <span style="color: #000000;font-weight: bold">nsw</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%0</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">1</span>         <span style="color: #a61717;background-color: #e3d2d2">|</span>   <span style="color: #008080">%inc</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">add</span> <span style="color: #000000;font-weight: bold">nsw</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">1</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%inc</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>  <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">void</span>                             <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">void</span>
<span style="background-color: #f8f8f8">}</span>                                    <span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_分支">分支</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c"><span style="color: #445588;font-weight: bold">int</span> <span style="color: #990000;font-weight: bold">bar</span><span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">y</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">x</span> <span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
    <span style="background-color: #f8f8f8">y</span> <span style="color: #000000;font-weight: bold">+=</span> <span style="color: #009999">1</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">}</span> <span style="color: #000000;font-weight: bold">else</span> <span style="background-color: #f8f8f8">{</span>
    <span style="background-color: #f8f8f8">y</span> <span style="color: #000000;font-weight: bold">+=</span> <span style="color: #009999">2</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">}</span>
  <span style="color: #000000;font-weight: bold">return</span> <span style="background-color: #f8f8f8">y</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>对比：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="llvm"><span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">@bar</span><span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%y</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>                <span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">@bar</span><span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%y</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
<span style="color: #990000;font-weight: bold">entry:</span>                                           <span style="color: #990000;font-weight: bold">entry:</span>
  <span style="color: #008080">%x.addr</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">alloca</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>               <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%y.addr</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">alloca</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>               <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%x.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>          <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%y</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%y.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>          <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%0</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">load</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%x.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>         <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%cmp</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">icmp</span> <span style="color: #000000;font-weight: bold">sgt</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%0</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">42</span>                  <span style="color: #a61717;background-color: #e3d2d2">|</span>    <span style="color: #008080">%cmp</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">icmp</span> <span style="color: #000000;font-weight: bold">sgt</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%x</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">42</span>
  <span style="color: #000000;font-weight: bold">br</span> <span style="color: #445588;font-weight: bold">i1</span> <span style="color: #008080">%cmp</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">label</span> <span style="color: #008080">%if.then</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">label</span> <span style="color: #008080">%if.else</span>       <span style="color: #000000;font-weight: bold">br</span> <span style="color: #445588;font-weight: bold">i1</span> <span style="color: #008080">%cmp</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">label</span> <span style="color: #008080">%if.then</span><span style="background-color: #f8f8f8">,</span> <span style="color: #445588;font-weight: bold">label</span> <span style="color: #008080">%if.else</span>

<span style="color: #990000;font-weight: bold">if.then:</span>                                         <span style="color: #990000;font-weight: bold">if.then:</span>
  <span style="color: #008080">%1</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">load</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%y.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>         <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%add</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">add</span> <span style="color: #000000;font-weight: bold">nsw</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%1</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">1</span>                    <span style="color: #a61717;background-color: #e3d2d2">|</span>    <span style="color: #008080">%add</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">add</span> <span style="color: #000000;font-weight: bold">nsw</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%y</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">1</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%add</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%y.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>        <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #000000;font-weight: bold">br</span> <span style="color: #445588;font-weight: bold">label</span> <span style="color: #008080">%if.end</span>                                 <span style="color: #000000;font-weight: bold">br</span> <span style="color: #445588;font-weight: bold">label</span> <span style="color: #008080">%if.end</span>

<span style="color: #990000;font-weight: bold">if.else:</span>                                         <span style="color: #990000;font-weight: bold">if.else:</span>
  <span style="color: #008080">%2</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">load</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%y.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>         <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #008080">%add1</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">add</span> <span style="color: #000000;font-weight: bold">nsw</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%2</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">2</span>                   <span style="color: #a61717;background-color: #e3d2d2">|</span>    <span style="color: #008080">%add</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">add</span> <span style="color: #000000;font-weight: bold">nsw</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%y</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">1</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%add1</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%y.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>       <span style="background-color: #f8f8f8">&lt;</span>
  <span style="color: #000000;font-weight: bold">br</span> <span style="color: #445588;font-weight: bold">label</span> <span style="color: #008080">%if.end</span>                                 <span style="color: #000000;font-weight: bold">br</span> <span style="color: #445588;font-weight: bold">label</span> <span style="color: #008080">%if.end</span>

<span style="color: #990000;font-weight: bold">if.end:</span>                                          <span style="color: #990000;font-weight: bold">if.end:</span>
  <span style="color: #008080">%3</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">load</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%y.addr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>         <span style="color: #a61717;background-color: #e3d2d2">|</span>    <span style="color: #008080">%y.addr.0</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">phi</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="background-color: #f8f8f8">[</span> <span style="color: #008080">%add</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">%if.then</span> <span style="background-color: #f8f8f8">],</span> <span style="background-color: #f8f8f8">[</span> <span style="color: #008080">%add1</span><span style="background-color: #f8f8f8">,</span> <span style="color: #008080">%if.else</span> <span style="background-color: #f8f8f8">]</span>
  <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%3</span>                                  <span style="color: #a61717;background-color: #e3d2d2">|</span>    <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #008080">%y.addr.0</span>
<span style="background-color: #f8f8f8">}</span>                                                <span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
实际上在这种情况中 LLVM 会改用 <a href="https://llvm.org/docs/LangRef.html#select-instruction:"><code>select</code></a> 指令。
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_循环">循环</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c"><span style="color: #445588;font-weight: bold">int</span> <span style="color: #990000;font-weight: bold">foo</span><span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">n</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">sum</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">;</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">i</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">;</span> <span style="background-color: #f8f8f8">i</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="background-color: #f8f8f8">n</span><span style="background-color: #f8f8f8">;</span> <span style="background-color: #f8f8f8">i</span><span style="color: #000000;font-weight: bold">++</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
    <span style="background-color: #f8f8f8">sum</span> <span style="color: #000000;font-weight: bold">+=</span> <span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">}</span>
  <span style="color: #000000;font-weight: bold">return</span> <span style="background-color: #f8f8f8">sum</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>对比</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code>define i32 @foo(i32 %n) {                         define i32 @foo(i32 %n) {
entry:                                            entry:
  %n.addr = alloca i32, align 4                &lt;
  %sum = alloca i32, align 4                   &lt;
  %i = alloca i32, align 4                     &lt;
  store i32 %n, ptr %n.addr, align 4           &lt;
  store i32 0, ptr %sum, align 4               &lt;
  store i32 0, ptr %i, align 4                 &lt;
  br label %for.cond                                br label %for.cond

for.cond:                                         for.cond:
  %0 = load i32, ptr %i, align 4               &lt;
  %1 = load i32, ptr %n.addr, align 4          &lt;
                                               &gt;    %sum.0 = phi i32 [ 0, %entry ], [ %add, %for.inc ]
                                               &gt;    %i.0 = phi i32 [ 0, %entry ], [ %inc, %for.inc ]
  %cmp = icmp slt i32 %0, %1                   |    %cmp = icmp slt i32 %i.0, %n
  br i1 %cmp, label %for.body, label %for.end       br i1 %cmp, label %for.body, label %for.end

for.body:                                         for.body:
  %2 = load i32, ptr %i, align 4               &lt;
  %3 = load i32, ptr %sum, align 4             &lt;
  %add = add nsw i32 %3, %2                    |    %add = add nsw i32 %sum.0, %i.0
  store i32 %add, ptr %sum, align 4            &lt;
  br label %for.inc                                 br label %for.inc

for.inc:                                          for.inc:
  %4 = load i32, ptr %i, align 4               &lt;
  %inc = add nsw i32 %4, 1                     |    %inc = add nsw i32 %i.0, 1
  store i32 %inc, ptr %i, align 4              &lt;
  br label %for.cond, !llvm.loop !6                 br label %for.cond, !llvm.loop !6

for.end:                                          for.end:
  %5 = load i32, ptr %sum, align 4             &lt;
  ret i32 %5                                   |    ret i32 %sum.0
}                                                 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>这里跟前面分支都有一个很有趣的点：除了 <code>ret</code>，其他的 terminator 指令都没有发生变化，也就是说，mem2reg 不会改变 CFG。</p>
</div>
</div>
<div class="sect2">
<h3 id="_指针">指针</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c"><span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">foo</span><span style="background-color: #f8f8f8">()</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">a</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">;</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">p</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">a</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>生成代码如下:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="llvm"><span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #008080">@foo</span><span style="background-color: #f8f8f8">()</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #008080">%a</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">alloca</span> <span style="color: #445588;font-weight: bold">i32</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>
  <span style="color: #008080">%p</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">alloca</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">8</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%a</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">4</span>
  <span style="color: #000000;font-weight: bold">store</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%a</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">%p</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">align</span> <span style="color: #009999">8</span>
  <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">void</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里有一个需要注意的点：尽管两条 alloca 最后都能去掉，但是 <code>%a</code> 必须在 <code>%p</code> 之后才能被干掉。这是因为最初 <code>%a</code> 的地址作为了第二条 store 的 value operand，如果去掉，对应的 store 就无法表示；而在 <code>%p</code> 被去掉以后，<code>%a</code> 只剩下一个 use，就可以被去掉了。因此 mem2reg 还需要以不动点的方式运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">while</span> <span style="background-color: #f8f8f8">(</span><span style="color: #0086B3">true</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #999988;font-style: italic">// 1. find AllocaInst&#39;s can be promoted</span>
  <span style="color: #999988;font-style: italic">// 2. if not found, exit the loop</span>
  <span style="color: #999988;font-style: italic">// 3. promote those AllocaInst&#39;s</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec:writing-mem2reg">自己实现一个 mem2reg</h2>
<div class="sectionbody">
<div class="paragraph">
<p>不难发现，提升 <code>alloca</code> 变量是围绕着 <code>store</code> 和 <code>load</code> 两类指令进行的，具体地：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>store</code> 是 def，<code>load</code> 是 use；</p>
</li>
<li>
<p>处理过程跟构建 SSA 很相似，涉及到 φ-node 的插入和重命名（重命名）；</p>
</li>
<li>
<p>完成替换后，需要删除无用的 <code>store</code>、<code>load</code> 和 <code>alloca</code>。</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如果不了解 SSA 形式的构建过程，可以参考 <a href="/posts/compilers/ssa-construction/">这篇文章</a>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>因此，大致流程可以是这样的：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>插入 φ-node</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>计算 IDF</p>
</li>
<li>
<p>创建 φ-node</p>
</li>
</ol>
</div>
</li>
<li>
<p>重命名</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>对于 BB 中每一条指令</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>如果是 store 和 phi，记录变量 AI 的新值</p>
</li>
<li>
<p>如果是 load，将所有 use 替换为 AI 当前值，并删除这条 load</p>
</li>
</ol>
</div>
</li>
<li>
<p>为每个后继中新增的 phi 添加入边</p>
</li>
<li>
<p>对于 dom. tree 中的每个子节点递归重命名</p>
</li>
<li>
<p>删除所有无用的 store</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_框架">框架</h3>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
你需要先了解如何在 LLVM 中实现一个 pass，参见 <a href="#bib:writing-an-llvm-pass-new-pm">[2]</a>。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>在 <code>include/llvm/Transforms/Utils</code> 中创建文件 <code>MyMemToReg.h</code>，加入如下的内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #999999;font-weight: bold">#ifndef LLVM_TRANSFORMS_UTILS_MYMEMTOREG_H
#define LLVM_TRANSFORMS_UTILS_MYMEMTOREG_H
</span>
<span style="color: #999999;font-weight: bold">#include</span> <span style="color: #999988;font-style: italic">&#34;llvm/IR/PassManager.h&#34;</span><span style="color: #999999;font-weight: bold">
</span>
<span style="color: #000000;font-weight: bold">namespace</span> <span style="background-color: #f8f8f8">llvm</span> <span style="background-color: #f8f8f8">{</span>

<span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">Function</span><span style="background-color: #f8f8f8">;</span>

<span style="color: #000000;font-weight: bold">struct</span> <span style="color: #445588;font-weight: bold">MyMemToRegPass</span> <span style="color: #000000;font-weight: bold">:</span> <span style="color: #000000;font-weight: bold">public</span> <span style="background-color: #f8f8f8">PassInfoMixin</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">MyMemToRegPass</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">{</span>
  <span style="background-color: #f8f8f8">PreservedAnalyses</span> <span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Function</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">F</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">FunctionAnalysisManager</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">AM</span><span style="background-color: #f8f8f8">);</span>
<span style="background-color: #f8f8f8">};</span>

<span style="background-color: #f8f8f8">}</span> <span style="color: #999988;font-style: italic">// end namespace llvm</span>

<span style="color: #999999;font-weight: bold">#endif  // LLVM_TRANSFORMS_UTILS_MYMEMTOREG_H</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
递归这里其实还有另一种做法，可以先处理 φ-node，后面在 LLVM 的 mem2reg 中会见到。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>先来搭框架（基本上就是前面列出的流程的直接映射）：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #999988;font-style: italic">// file: MyMemToReg.cpp</span>
<span style="background-color: #f8f8f8">PreservedAnalyses</span> <span style="background-color: #f8f8f8">MyMemToRegPass</span><span style="color: #000000;font-weight: bold">::</span><span style="background-color: #f8f8f8">run</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Function</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">F</span><span style="background-color: #f8f8f8">,</span>
                                      <span style="background-color: #f8f8f8">FunctionAnalysisManager</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">AM</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #999988;font-style: italic">// 我们在两个阶段都需要用的 dom. tree</span>
  <span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">DT</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">AM</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">getResult</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">DominatorTreeAnalysis</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">F</span><span style="background-color: #f8f8f8">);</span>

  <span style="color: #999988;font-style: italic">// 用于返回时判断哪些分析结果可以被保留</span>
  <span style="color: #445588;font-weight: bold">bool</span> <span style="background-color: #f8f8f8">Changed</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #0086B3">false</span><span style="background-color: #f8f8f8">;</span>

  <span style="background-color: #f8f8f8">SmallVector</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">32</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">;</span>
  <span style="color: #000000;font-weight: bold">while</span> <span style="background-color: #f8f8f8">(</span><span style="color: #0086B3">true</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #999988;font-style: italic">// 收集这一轮能够提升的 alloca</span>
    <span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">clear</span><span style="background-color: #f8f8f8">();</span>
    <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">InstRef</span> <span style="color: #000000;font-weight: bold">:</span> <span style="background-color: #f8f8f8">F</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">getEntryBlock</span><span style="background-color: #f8f8f8">())</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">AllocaInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">InstRef</span><span style="background-color: #f8f8f8">))</span>
        <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">canPromote</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">push_back</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">);</span>
    <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">empty</span><span style="background-color: #f8f8f8">())</span> <span style="color: #000000;font-weight: bold">break</span><span style="background-color: #f8f8f8">;</span>

    <span style="background-color: #f8f8f8">doPromote</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">DT</span><span style="background-color: #f8f8f8">);</span>

    <span style="background-color: #f8f8f8">Changed</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #0086B3">true</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">}</span>

  <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">Changed</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">return</span> <span style="background-color: #f8f8f8">PreservedAnalyses</span><span style="color: #000000;font-weight: bold">::</span><span style="background-color: #f8f8f8">all</span><span style="background-color: #f8f8f8">();</span>
  <span style="background-color: #f8f8f8">PreservedAnalyses</span> <span style="background-color: #f8f8f8">PA</span><span style="background-color: #f8f8f8">;</span>
  <span style="color: #999988;font-style: italic">// 如前文所述，mem2reg 不会改变 CFG</span>
  <span style="background-color: #f8f8f8">PA</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">preserveSet</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">CFGAnalyses</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">();</span>
  <span style="color: #000000;font-weight: bold">return</span> <span style="background-color: #f8f8f8">PA</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>接下来是 <code>canPromote</code>，用于判断哪些 alloca 能够提升：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">static</span> <span style="color: #445588;font-weight: bold">bool</span> <span style="color: #990000;font-weight: bold">canPromote</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">const</span> <span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">const</span> <span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">U</span> <span style="color: #000000;font-weight: bold">:</span> <span style="background-color: #f8f8f8">AI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">users</span><span style="background-color: #f8f8f8">())</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">SI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">StoreInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">U</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
      <span style="color: #999988;font-style: italic">// 1. 如果 alloca 是作为被存入的值，不能提升</span>
      <span style="color: #999988;font-style: italic">// 2. 这里涉及到“透明指针”，LLVM 目前在使用指针时不关心指针指向的类型，例如</span>
      <span style="color: #999988;font-style: italic">//      %0 = alloca i32, align 4</span>
      <span style="color: #999988;font-style: italic">//      %1 = load i16, ptr %0, align 4</span>
      <span style="color: #999988;font-style: italic">//    参见 https://llvm.org/docs/OpaquePointers.html</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">SI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getValueOperand</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">==</span> <span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">||</span>
          <span style="background-color: #f8f8f8">SI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getValueOperand</span><span style="background-color: #f8f8f8">()</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getType</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">!=</span> <span style="background-color: #f8f8f8">AI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getAllocatedType</span><span style="background-color: #f8f8f8">())</span> <span style="background-color: #f8f8f8">{</span>
        <span style="color: #000000;font-weight: bold">return</span> <span style="color: #0086B3">false</span><span style="background-color: #f8f8f8">;</span>
      <span style="background-color: #f8f8f8">}</span>
    <span style="background-color: #f8f8f8">}</span> <span style="color: #000000;font-weight: bold">else</span> <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">LI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">LoadInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">U</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
      <span style="color: #999988;font-style: italic">// 同上</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getType</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">!=</span> <span style="background-color: #f8f8f8">AI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getAllocatedType</span><span style="background-color: #f8f8f8">())</span> <span style="background-color: #f8f8f8">{</span>
        <span style="color: #000000;font-weight: bold">return</span> <span style="color: #0086B3">false</span><span style="background-color: #f8f8f8">;</span>
      <span style="background-color: #f8f8f8">}</span>
    <span style="background-color: #f8f8f8">}</span> <span style="color: #000000;font-weight: bold">else</span> <span style="background-color: #f8f8f8">{</span>
      <span style="color: #999988;font-style: italic">// 如果被任何其它类型的指令使用，不提升</span>
      <span style="color: #000000;font-weight: bold">return</span> <span style="color: #0086B3">false</span><span style="background-color: #f8f8f8">;</span>
    <span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">}</span>
  <span style="color: #000000;font-weight: bold">return</span> <span style="color: #0086B3">true</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>为了保持简单，我们这里忽略了 load 和 store 的 volatile 问题。实际上，如果有 volatile，那么是不能提升的，因为 LLVM IR 将 volatile 访问定义为有“可见的副作用”（visible side effects）<a href="#bib:llvm-langref-volatile">[6]</a></p>
</div>
<div class="paragraph">
<p>接下来是 <code>doPromote</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">static</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">doPromote</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">const</span> <span style="background-color: #f8f8f8">SmallVectorImpl</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*&gt;</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">,</span>
                      <span style="background-color: #f8f8f8">DominatorTree</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">DT</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #999988;font-style: italic">// 记录 phi-node 到 alloca 的对应关系</span>
  <span style="background-color: #f8f8f8">DenseMap</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">PHINode</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*&gt;</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">;</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">:</span> <span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
    <span style="background-color: #f8f8f8">SmallPtrSet</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">BasicBlock</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">8</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">DefiningBlocks</span><span style="background-color: #f8f8f8">;</span>
    <span style="background-color: #f8f8f8">getDefiningBlocks</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">DefiningBlocks</span><span style="background-color: #f8f8f8">);</span>

    <span style="background-color: #f8f8f8">ForwardIDFCalculator</span> <span style="background-color: #f8f8f8">IDF</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">DT</span><span style="background-color: #f8f8f8">);</span>
    <span style="background-color: #f8f8f8">IDF</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">setDefiningBlocks</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">DefiningBlocks</span><span style="background-color: #f8f8f8">);</span>
    <span style="background-color: #f8f8f8">SmallVector</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">BasicBlock</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">,</span> <span style="color: #009999">8</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">PHIBlocks</span><span style="background-color: #f8f8f8">;</span>
    <span style="background-color: #f8f8f8">IDF</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">calculate</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PHIBlocks</span><span style="background-color: #f8f8f8">);</span>

    <span style="background-color: #f8f8f8">insertPHINodes</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">PHIBlocks</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">);</span>
  <span style="background-color: #f8f8f8">}</span>

  <span style="background-color: #f8f8f8">DenseMap</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">std</span><span style="color: #000000;font-weight: bold">::</span><span style="background-color: #f8f8f8">stack</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">Value</span> <span style="color: #000000;font-weight: bold">*&gt;&gt;</span> <span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">;</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">unsigned</span> <span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">E</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">size</span><span style="background-color: #f8f8f8">();</span> <span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">!=</span> <span style="background-color: #f8f8f8">E</span><span style="background-color: #f8f8f8">;</span> <span style="background-color: #f8f8f8">I</span><span style="color: #000000;font-weight: bold">++</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #999988;font-style: italic">// 可能存在没有被任何 store 支配的 load 和 phi-node 用 ⊥ 兜底</span>
    <span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">I</span><span style="background-color: #f8f8f8">]].</span><span style="background-color: #f8f8f8">push</span><span style="background-color: #f8f8f8">(</span>
        <span style="background-color: #f8f8f8">UndefValue</span><span style="color: #000000;font-weight: bold">::</span><span style="background-color: #f8f8f8">get</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">I</span><span style="background-color: #f8f8f8">]</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getAllocatedType</span><span style="background-color: #f8f8f8">()));</span>
  <span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">doRename</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">DT</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">getRootNode</span><span style="background-color: #f8f8f8">(),</span> <span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">);</span>

  <span style="color: #999988;font-style: italic">// 在最后删除无用的 alloca</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">:</span> <span style="background-color: #f8f8f8">Allocas</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
    <span style="background-color: #f8f8f8">AI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">eraseFromParent</span><span style="background-color: #f8f8f8">();</span>
  <span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>getDefiningBlocks</code> 和 <code>insertPHINodes</code> 很简单，这里不再贴代码解释。重点是 <code>doRename</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">static</span> <span style="color: #445588;font-weight: bold">void</span>
<span style="color: #990000;font-weight: bold">doRename</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">DomTreeNode</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">DN</span><span style="background-color: #f8f8f8">,</span>
         <span style="background-color: #f8f8f8">DenseMap</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">std</span><span style="color: #000000;font-weight: bold">::</span><span style="background-color: #f8f8f8">stack</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">Value</span> <span style="color: #000000;font-weight: bold">*&gt;&gt;</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">,</span>
         <span style="background-color: #f8f8f8">DenseMap</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">PHINode</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*&gt;</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #999988;font-style: italic">// 替换 load 指令</span>
  <span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">BB</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">DN</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getBlock</span><span style="background-color: #f8f8f8">();</span>
  <span style="color: #999988;font-style: italic">// 注意这里的 make_early_inc_range，由于 LI-&gt;eraseFromParent 会导致迭代器失效，</span>
  <span style="color: #999988;font-style: italic">// 如果不用这个函数包装一下，运行时会崩溃</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">InstRef</span> <span style="color: #000000;font-weight: bold">:</span> <span style="background-color: #f8f8f8">make_early_inc_range</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">BB</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">Inst</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">InstRef</span><span style="background-color: #f8f8f8">;</span>
    <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">SI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">StoreInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Inst</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
      <span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">AllocaInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">SI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getPointerOperand</span><span style="background-color: #f8f8f8">());</span>
      <span style="color: #999988;font-style: italic">// 确保这是一条 alloca 并且可以提升</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">||</span> <span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">count</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">))</span> <span style="color: #000000;font-weight: bold">continue</span><span style="background-color: #f8f8f8">;</span>
      <span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">push</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">SI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getValueOperand</span><span style="background-color: #f8f8f8">());</span>
    <span style="background-color: #f8f8f8">}</span> <span style="color: #000000;font-weight: bold">else</span> <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">PHI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">PHINode</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Inst</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
      <span style="color: #000000;font-weight: bold">auto</span> <span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PHI</span><span style="background-color: #f8f8f8">);</span>
      <span style="color: #999988;font-style: italic">// 我们插入 phi-node 时，都是在 BB 的最开始连续插入的，因此遇到不在</span>
      <span style="color: #999988;font-style: italic">// AllocasByPHINode 的 phi-node 说明已经处理完了本轮插入的 phi-node</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">==</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">end</span><span style="background-color: #f8f8f8">())</span> <span style="color: #000000;font-weight: bold">break</span><span style="background-color: #f8f8f8">;</span>
      <span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">I</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">push</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PHI</span><span style="background-color: #f8f8f8">);</span>
    <span style="background-color: #f8f8f8">}</span> <span style="color: #000000;font-weight: bold">else</span> <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">LI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">LoadInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Inst</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
      <span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">AllocaInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getPointerOperand</span><span style="background-color: #f8f8f8">());</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">||</span> <span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">count</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">))</span> <span style="color: #000000;font-weight: bold">continue</span><span style="background-color: #f8f8f8">;</span>
      <span style="background-color: #f8f8f8">LI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">replaceAllUsesWith</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">top</span><span style="background-color: #f8f8f8">());</span>
      <span style="background-color: #f8f8f8">LI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">eraseFromParent</span><span style="background-color: #f8f8f8">();</span>
    <span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">...</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>下一步是递归：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">static</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">doRename</span><span style="background-color: #f8f8f8">(...)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="background-color: #f8f8f8">...</span>
  <span style="color: #999988;font-style: italic">// 注意这里是修改所有 succ 的 phi-node</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">S</span> <span style="color: #000000;font-weight: bold">:</span> <span style="background-color: #f8f8f8">successors</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">BB</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">InstRef</span> <span style="color: #000000;font-weight: bold">:</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">S</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
      <span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">PHI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">PHINode</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">InstRef</span><span style="background-color: #f8f8f8">);</span>
      <span style="color: #999988;font-style: italic">// If the instruction is not a phi-node, exit the loop.</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">PHI</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">break</span><span style="background-color: #f8f8f8">;</span>
      <span style="color: #000000;font-weight: bold">auto</span> <span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PHI</span><span style="background-color: #f8f8f8">);</span>
      <span style="color: #999988;font-style: italic">// Finding a phi-node not in AllocasByPHINode means we are done with</span>
      <span style="color: #999988;font-style: italic">// those phi-nodes we inserted.</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">==</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">end</span><span style="background-color: #f8f8f8">())</span> <span style="color: #000000;font-weight: bold">break</span><span style="background-color: #f8f8f8">;</span>
      <span style="background-color: #f8f8f8">PHI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">addIncoming</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">I</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">top</span><span style="background-color: #f8f8f8">(),</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">BB</span><span style="background-color: #f8f8f8">);</span>
    <span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">}</span>

  <span style="color: #999988;font-style: italic">// 注意这里仅仅是对 dom. tree 中的子节点进行递归，因为没有被当前 BB</span>
  <span style="color: #999988;font-style: italic">// dominate 的 succ 一定会有对应的 phi-node，且仅需要处理这些 phi-node</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">C</span> <span style="color: #000000;font-weight: bold">:</span> <span style="background-color: #f8f8f8">DN</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">children</span><span style="background-color: #f8f8f8">())</span> <span style="background-color: #f8f8f8">{</span>
    <span style="background-color: #f8f8f8">doRename</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">C</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">);</span>
  <span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>最后，删除无用的 store，并还原 value stack：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">static</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">doRename</span><span style="background-color: #f8f8f8">(...)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="background-color: #f8f8f8">...</span>
  <span style="color: #999988;font-style: italic">// 同样需要使用 make_early_inc_range，这个循环跟第一个很类似</span>
  <span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">InstRef</span> <span style="color: #000000;font-weight: bold">:</span> <span style="background-color: #f8f8f8">make_early_inc_range</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">BB</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">Inst</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">InstRef</span><span style="background-color: #f8f8f8">;</span>
    <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">SI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">StoreInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Inst</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
      <span style="background-color: #f8f8f8">AllocaInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">AllocaInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">SI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getPointerOperand</span><span style="background-color: #f8f8f8">());</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">AI</span> <span style="color: #000000;font-weight: bold">||</span> <span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">count</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">))</span> <span style="color: #000000;font-weight: bold">continue</span><span style="background-color: #f8f8f8">;</span>
      <span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">pop</span><span style="background-color: #f8f8f8">();</span>
      <span style="background-color: #f8f8f8">SI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">eraseFromParent</span><span style="background-color: #f8f8f8">();</span>
    <span style="background-color: #f8f8f8">}</span> <span style="color: #000000;font-weight: bold">else</span> <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">auto</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">PHI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">PHINode</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Inst</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
      <span style="color: #000000;font-weight: bold">auto</span> <span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PHI</span><span style="background-color: #f8f8f8">);</span>
      <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">==</span> <span style="background-color: #f8f8f8">AllocasByPHINode</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">end</span><span style="background-color: #f8f8f8">())</span> <span style="color: #000000;font-weight: bold">break</span><span style="background-color: #f8f8f8">;</span>
      <span style="background-color: #f8f8f8">StacksByAlloca</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">find</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">I</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">)</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">second</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">pop</span><span style="background-color: #f8f8f8">();</span>
    <span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>别忘了把 pass 注册到 PassRegistry.def 和 PassBuilder 中。编译之后就可以用 opt 调用了：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="plaintext">$ opt -passes=my-mem-to-reg -S ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>完整代码参见 <a href="code/MyMemToReg.h">MyMemToReg.h</a> 和 <a href="code/MyMemToReg.cpp">MyMemToReg.cpp</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec:reading-llvm-mem2reg">LLVM 的实现</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LLVM 的实现的框架跟我们自己的类似，多了一些优化和细节上的考虑。</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
这里比较凌乱，不过尽量保证了大框架的规整。如果你在读代码过程中有一些不理解的问题，可以来看看这里有没有相关内容。更欢迎解答我的疑惑！
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_判断能否提升">判断能否提升</h3>
<div class="paragraph">
<p>如 <code>isAllocaPromotable</code> 的注释所说的：“Only allow direct and non-volatile loads and stores”。</p>
</div>
<div class="paragraph">
<p>mem2reg 只允许被提升变量的 uses 包含某些特定的指令，而且这些 uses 也必须满足一定的限制。目前（LLVM17）这些指令包括：LoadInst、StoreInst、IntrinsicInst、BitCastInst、GetElementPtrInst 和 AddrSpaceCastInst。</p>
</div>
<div class="paragraph">
<p>LoadInst 的分支中如下的测试比较令人疑惑（StoreInst 也有类似的）:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">const</span> <span style="background-color: #f8f8f8">LoadInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">LI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">LoadInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">U</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #999988;font-style: italic">//                      vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv</span>
  <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">isVolatile</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">||</span> <span style="background-color: #f8f8f8">LI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getType</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">!=</span> <span style="background-color: #f8f8f8">AI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getAllocatedType</span><span style="background-color: #f8f8f8">())</span>
    <span style="color: #000000;font-weight: bold">return</span> <span style="color: #0086B3">false</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这个在文档中没有说明，不过通过翻 Git 历史（<a href="https://github.com/llvm/llvm-project/commit/074561a4a22f610d756109170285d8626c4cc3bc">这个</a>和<a href="https://reviews.llvm.org/D109259">这个</a>）看到了原因：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Alloca promotion can only deal with cases where the load/store types match the alloca type (it explicitly does not support bitcasted load/stores).</p>
</div>
<div class="paragraph">
<p>With <a href="https://llvm.org/docs/OpaquePointers.html">opaque pointers</a> this is no longer enforced through the pointer type, so add an explicit check.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>至于 volatile，参见 <a href="#bib:llvm-langref-volatile">[6]</a>。</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A volatile load or store may have additional target-specific semantics. Any volatile operation can have side effects, and any volatile operation can read and/or modify state which is not accessible via a regular load or store in this module. Volatile operations may use addresses which do not point to memory (like MMIO registers). This means the compiler may not use a volatile operation to prove a non-volatile access to that address has defined behavior.</p>
</div>
</blockquote>
<div class="attribution">
— LLVM Programmer&#39;s Manual
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">LLVM 的 Intrinsic Function</div>
<div class="paragraph">
<p>LLVM 的 intrinsic function 是由 LLVM 编译器特殊处理的函数。这些函数通常低级操作，要么在源语言中无法表达，要么用普通的函数调用实现成本太高。Intrinsic function 提供了更多的优化空间，例如，LLVM 可以将它们内联，特化或者用 target-specific 指令代替（摘录自 ChatGPT 的回答）。</p>
</div>
<div class="paragraph">
<p>这些函数具有众所周知的名称和语义，并且需要遵循某些限制。总的来说，这些内在函数代表了 LLVM 语言的扩展机制，在添加到语言中时不需要更改 LLVM 中的所有变换<a href="#bib:llvm-langref">[4]</a>。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>llvm.pseudoprobe</code> 用于加入探针，可以进行 PGO</p>
</li>
<li>
<p><code>llvm.assume</code> 用于为优化器和代码生成器提供无法通过代码本身提供的信息，例如在某个程序点假设 <code>x &gt; 0</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>TODO: 除了 load/store 之外，其他四个指令的特殊限制暂时还没想明白</p>
</div>
</div>
<div class="sect2">
<h3 id="_promotemem2regrun">PromoteMem2Reg::run</h3>
<div class="paragraph">
<p>TODO: droppable user
TODO: removeIntrinsicUsers 为什么要过滤掉 void 类型的 Inst（目前应该只有 probe 是 void 的，但是 probe 本身是可以 droppable）
TODO: 如果将 probe 和 assume 移除了，如何保留原来的功能？</p>
</div>
<div class="paragraph">
<p>这个函数的流程如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>将所有 trivial 的 alloca 及相关的 store 和 load 移除（包括没有 use 的、只有一个 store 的和所有的 use 在同一个 BB 的）</p>
</li>
<li>
<p>对于非 trivial 的 alloca，进行通用的插入 φ-node 和重命名的操作</p>
</li>
<li>
<p>删除无用的 alloca</p>
</li>
<li>
<p>处理 φ-node 相关的边界情况，包括简化 φ-node 和完善不可达 BB 的 φ-node</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>removeIntrinsicUsers 结束之后，我们只需要关心 load 和 store 即可。</p>
</div>
<div class="sect3">
<h4 id="_边界情况">边界情况</h4>
<div class="paragraph">
<p>如注释所说的：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Loop over all of the PHI nodes and see if there are any that we can get rid of because they merge all of the same incoming values.  This can happen due to undef values coming into the PHI nodes.  This process is iterative, because eliminating one PHI node can cause others to be removed.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>TODO: non-deterministic def-use chain 会有什么影响吗？
TODO: unreachable bb 为什么还需要处理？不会被去掉吗？</p>
</div>
<div class="paragraph">
<p>关于最后补足 φ-node 的入边，通过入边的数量来区分哪些 φ-node 是本轮 mem2reg 插入的（换句话说，何时停止），那么如果恰好有在 mem2reg 之前已经存在的 phi 的 incoming 跟 mem2reg 添加的数量一样，岂不是会出问题？就目前能想到的情况而言，还好——要么要求前面的 pass 保证做了同样的处理，要么本轮给补充完整，反正是 undef，问题不大。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rewritesinglestorealloca">rewriteSingleStoreAlloca</h3>
<div class="paragraph">
<p>该函数中有一个判断：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #445588;font-weight: bold">bool</span> <span style="background-color: #f8f8f8">StoringGlobalVal</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">isa</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">Instruction</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">OnlyStore</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getOperand</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">));</span>
<span style="color: #999988;font-style: italic">/* ... */</span>
<span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #999988;font-style: italic">/* ... */</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">StoringGlobalVal</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span> <span style="color: #999988;font-style: italic">/* ... */</span> <span style="background-color: #f8f8f8">}</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里的目的是将所有被 <code>store</code> dominate 的 <code>load</code> 替换成 <code>store</code> 的参数，如果存在没有被 dominate 的走通用流程（这一点通常应该对应于未初始化的局部变量，不过至少在 C11 中，这种行为不是 UB，仅仅会导致读取出来的值是“indetermine”的，因此走通用流程是合理的）。函数的参数（类型为 <code>llvm::Argument</code>）和全局变量（类型为 <code>llvm::GlobalValue</code>）均属于“non-instructions”（也许这个变量的名字改成 <code>StoringNonInstValue</code> 更合适），其中函数参数确保在进入函数体之前就存在了，而且本身作为寄存器变量保证了不会被修改，因此“always dominated”，可以直接替换。不过全局变量其实涉及到一个很小的点。我们来看如下的代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c"><span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">foo</span><span style="background-color: #f8f8f8">()</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #000000;font-weight: bold">static</span> <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">baz</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">42</span><span style="background-color: #f8f8f8">;</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">p</span><span style="background-color: #f8f8f8">,</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">q</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">p</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">printf</span><span style="background-color: #f8f8f8">(</span><span style="color: #d14">&#34;%p %p</span><span style="color: #d14">\n</span><span style="color: #d14">&#34;</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">p</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">q</span><span style="background-color: #f8f8f8">);</span>
  <span style="background-color: #f8f8f8">p</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">&amp;</span><span style="background-color: #f8f8f8">baz</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">q</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">p</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这段代码在我的机器上（amd64，clang，-O0/-O1/-O2/-O3/-Ofast）会输出两个相同的值，即 <code>baz</code> 的地址。优化后的结果是这样的：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="llvm"><span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #008080">@foo</span><span style="background-color: #f8f8f8">()</span> <span style="background-color: #f8f8f8">{</span>
<span style="color: #990000;font-weight: bold">entry:</span>
  <span style="color: #999988;font-style: italic">;                                                  vvvvvvvv      vvvvvvvv</span>
  <span style="color: #008080">%call</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">call</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">ptr</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">...)</span> <span style="color: #008080">@printf</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">@.str</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">@bar.baz</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">@bar.baz</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">void</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果将最后两行注释掉，又会输出两个不同于 <code>baz</code> 的地址的值</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="llvm"><span style="color: #000000;font-weight: bold">define</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #008080">@foo</span><span style="background-color: #f8f8f8">()</span> <span style="background-color: #f8f8f8">{</span>
<span style="color: #990000;font-weight: bold">entry:</span>
  <span style="color: #999988;font-style: italic">;                                                  vvvvv      vvvvv</span>
  <span style="color: #008080">%call</span> <span style="background-color: #f8f8f8">=</span> <span style="color: #000000;font-weight: bold">call</span> <span style="color: #445588;font-weight: bold">i32</span> <span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">ptr</span><span style="background-color: #f8f8f8">,</span> <span style="background-color: #f8f8f8">...)</span> <span style="color: #008080">@printf</span><span style="background-color: #f8f8f8">(</span><span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #008080">@.str</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #000000;font-weight: bold">undef</span><span style="background-color: #f8f8f8">,</span> <span style="color: #a61717;background-color: #e3d2d2">ptr</span> <span style="color: #000000;font-weight: bold">undef</span><span style="background-color: #f8f8f8">)</span>
  <span style="color: #000000;font-weight: bold">ret</span> <span style="color: #445588;font-weight: bold">void</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>直接原因是，当 store 的内容是全局变量时 <code>StoringGlobalVal</code> 为 true，执行流跳过了 <code>if</code> 分支，直接将出现在<strong>后面</strong>的 <code>store</code> 的值替换到出现在<strong>前面</strong>的 <code>load</code>。不过，使用未初始化的局部变量是 UB<a href="#bib:c11-annex-j.2">[5]</a>，所以其实影响不大（我在 LLVM 社区提了一个<a href="https://discourse.llvm.org/t/question-about-mem2regs-handling-of-global-variables/69279">问题</a>，忽略我的英语）。</p>
</div>
</div>
<div class="sect2">
<h3 id="_promotesingleblockalloca">promoteSingleBlockAlloca</h3>
<div class="paragraph">
<p>有一个比较特殊的点——当发现一个 load 之前没有任何 store 时，直觉上将 load 的 uses 替换为 undef 就好（因为当前情况是所有的 load 和 store 都在同一个 BB 中），但是 LLVM 进行了分情况考虑：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>如果没有任何 store，将 load 替换为 undef</p>
</li>
<li>
<p>否则，返回 false 用通用逻辑</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
这里 <code>llvm::lower_bound</code> 返回的是紧跟着 load 的 store 的索引，因此如果 <code>it == begin()</code>，因为这 load 之前没有 store
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>关键在于，这里考虑的<strong>仅仅</strong>是 load 和 store，但是还有 alloca！mem2reg 只考虑 entry 中的 alloca，也就是说 alloca 一定 dominate 所有的 store 和 load。考虑如下的 BB：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/only-in-one-bb.png" alt="only in one bb"/>
</div>
</div>
<div class="paragraph">
<p>这里 <code>%gotcha</code> 虽然一开始是 undef，但是后面会被修改。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">等价 C 代码</div>
<div class="paragraph">
<p>如下代码会产生上述行为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c"><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">gotcha</span><span style="background-color: #f8f8f8">;</span>
<span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">i</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #009999">0</span><span style="background-color: #f8f8f8">;</span> <span style="background-color: #f8f8f8">i</span> <span style="color: #000000;font-weight: bold">&lt;</span> <span style="color: #009999">10</span><span style="background-color: #f8f8f8">;</span> <span style="background-color: #f8f8f8">i</span><span style="color: #000000;font-weight: bold">++</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #445588;font-weight: bold">int</span> <span style="background-color: #f8f8f8">t</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">gotcha</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">t</span><span style="color: #000000;font-weight: bold">++</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">gotcha</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">t</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_promotemem2regcomputeliveinblocks">PromoteMem2Reg::ComputeLiveInBlocks</h3>
<div class="paragraph">
<p>进行 liveness 分析<a href="#bib:liveness-analysis">[7]</a>，这主要是为了消除无用的 φ-node，也就是说，最终 mem2reg 的结果是 pruned 形式。</p>
</div>
<div class="paragraph">
<p>分析的流程也比较直观：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>从 uses 开始，先将没有 live-in 的 block 剔除，这里的逻辑有一点绕</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">for</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">BasicBlock</span><span style="color: #000000;font-weight: bold">::</span><span style="background-color: #f8f8f8">iterator</span> <span style="background-color: #f8f8f8">I</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">BB</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">begin</span><span style="background-color: #f8f8f8">();;</span> <span style="color: #000000;font-weight: bold">++</span><span style="background-color: #f8f8f8">I</span><span style="background-color: #f8f8f8">)</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">StoreInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">SI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">StoreInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">I</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">SI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getOperand</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">1</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">!=</span> <span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">)</span>
      <span style="color: #000000;font-weight: bold">continue</span><span style="background-color: #f8f8f8">;</span>

    <span style="background-color: #f8f8f8">LiveInBlockWorklist</span><span style="background-color: #f8f8f8">[</span><span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">]</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">LiveInBlockWorklist</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">back</span><span style="background-color: #f8f8f8">();</span>
    <span style="background-color: #f8f8f8">LiveInBlockWorklist</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">pop_back</span><span style="background-color: #f8f8f8">();</span>
    <span style="color: #000000;font-weight: bold">--</span><span style="background-color: #f8f8f8">i</span><span style="background-color: #f8f8f8">;</span>
    <span style="color: #000000;font-weight: bold">--</span><span style="background-color: #f8f8f8">e</span><span style="background-color: #f8f8f8">;</span>
    <span style="color: #000000;font-weight: bold">break</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">}</span>

  <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LoadInst</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">LI</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">LoadInst</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">I</span><span style="background-color: #f8f8f8">))</span>
    <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">LI</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getOperand</span><span style="background-color: #f8f8f8">(</span><span style="color: #009999">0</span><span style="background-color: #f8f8f8">)</span> <span style="color: #000000;font-weight: bold">==</span> <span style="background-color: #f8f8f8">AI</span><span style="background-color: #f8f8f8">)</span>
      <span style="color: #000000;font-weight: bold">break</span><span style="background-color: #f8f8f8">;</span>
<span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>进入这个循环时能够确定的是，<code>BB</code> 包含 <code>AI</code> 的 def 和 use，为了确定是否 live-in，我们需要确定 def 和 use 出现的先后顺序——如果先出现的是 def，那么没有 live-in，需要将 BB 从 work list 中删除；如果先出现的是 use，那么 live-in，保留。为了实现这个逻辑，这里使用了两个并列的、可能跳出循环的 <code>if</code>，找到的是第一个使用 <code>AI</code> 的 load 或者 store。如果找到的是 store，那么说明没有 live-in，否则，说明 live-in。</p>
</div>
</li>
<li>
<p>然后就是经典的 backward data-flow analysis</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>结束 liveness 分析，就可以开始进行插入 φ-node 和 rename 的工作了。插入 φ-node 比较简单，因为已经有了 IDF。</p>
</div>
<div class="paragraph">
<p>为什么要对 PHIBlocks 进行排序？目前能想到的唯一理由就是让 <code>Version</code> 增加的顺序跟 BB 的顺序一致。</p>
</div>
</div>
<div class="sect2">
<h3 id="_renamepass">RenamePass</h3>
<div class="paragraph">
<p>手动将递归转换为了迭代，见 commit 记录：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Change the rename pass to be &#34;tail recursive&#34;, only adding N-1 successors
to the worklist, and handling the last one with a &#39;tail call&#39;. This speeds
up PR1432 from 2.0578s to 2.0012s (2.8%)</p>
</div>
</blockquote>
<div class="attribution">
— Chris Lattner
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #990000;font-weight: bold">NextIteration:</span>
  <span style="color: #999988;font-style: italic">// 当前 BB 是否有 phi-node? 注意, 我们假设 BB 中所有的 phi-node 一定出现</span>
  <span style="color: #999988;font-style: italic">// 在开头的部分</span>
  <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PHINode</span> <span style="color: #000000;font-weight: bold">*</span><span style="background-color: #f8f8f8">APN</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">PHINode</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">BB</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">begin</span><span style="background-color: #f8f8f8">()))</span> <span style="background-color: #f8f8f8">{</span>
    <span style="color: #999988;font-style: italic">// 由于我们的 phi-node 是在 BB 的最前面插入的, 所以如果</span>
    <span style="color: #999988;font-style: italic">// PhiToAllocaMap.count(APN) 不为 0, 那么说明我们在当前 BB 插入了</span>
    <span style="color: #999988;font-style: italic">// phi-node.</span>
    <span style="color: #999988;font-style: italic">//</span>
    <span style="color: #999988;font-style: italic">// 有了这两个保证, 我们可以确认当前 BB 有需要 rename 的 phi-node.</span>
    <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PhiToAllocaMap</span><span style="background-color: #f8f8f8">.</span><span style="background-color: #f8f8f8">count</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">APN</span><span style="background-color: #f8f8f8">))</span> <span style="background-color: #f8f8f8">{</span>
      <span style="color: #999988;font-style: italic">/* ... */</span>
      <span style="color: #999988;font-style: italic">// 第一个被处理的 BB 是 entry, 但是由于 entry 没有 phi-node,</span>
      <span style="color: #999988;font-style: italic">// 所以控制流根本不会走到这里, 因此不会崩溃.</span>
      <span style="color: #445588;font-weight: bold">unsigned</span> <span style="background-color: #f8f8f8">NumEdge</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">llvm</span><span style="color: #000000;font-weight: bold">::</span><span style="background-color: #f8f8f8">count</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">successors</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">Pred</span><span style="background-color: #f8f8f8">),</span> <span style="background-color: #f8f8f8">BB</span><span style="background-color: #f8f8f8">);</span>
    <span style="background-color: #f8f8f8">}</span>
  <span style="background-color: #f8f8f8">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>接下来就是给 φ-node 添加入边，流程很直观：首先获取 φ-node 的迭代器（也就是 Instruction 的迭代器，调用 <code>BB.begin</code> 即可），然后给遇到的每一个 φ-node 调用 <code>addIncoming</code> 添加入边，同时还要记得由于 φ-node 本身就是变量的 def，要用它更新变量当前的值。</p>
</div>
<div class="paragraph">
<p>不过，这里有一个需要注意的问题：我们并没有记录 mem2reg 在当前 BB 添加了多少 φ-node，因此需要其他的方式确定何时停止。LLVM 解决的方式基于一个前提，即，新添加的（没有调用过 <code>addIncoming</code> 的）φ-node 的 <code>getNumOperands</code> 的结果都是一样的，一旦遇见一个不一样的，说明就不是 mem2reg 添加的，就可以终止。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="c++"><span style="color: #000000;font-weight: bold">do</span> <span style="background-color: #f8f8f8">{</span>
  <span style="color: #000000;font-weight: bold">++</span><span style="background-color: #f8f8f8">PNI</span><span style="background-color: #f8f8f8">;</span>
  <span style="background-color: #f8f8f8">APN</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">dyn_cast</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="background-color: #f8f8f8">PHINode</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">PNI</span><span style="background-color: #f8f8f8">);</span>
  <span style="color: #000000;font-weight: bold">if</span> <span style="background-color: #f8f8f8">(</span><span style="color: #000000;font-weight: bold">!</span><span style="background-color: #f8f8f8">APN</span><span style="background-color: #f8f8f8">)</span>
    <span style="color: #000000;font-weight: bold">break</span><span style="background-color: #f8f8f8">;</span>
  <span style="color: #999988;font-style: italic">// 这里的判断基于下一个待处理的 phi-node</span>
<span style="background-color: #f8f8f8">}</span> <span style="color: #000000;font-weight: bold">while</span> <span style="background-color: #f8f8f8">(</span><span style="background-color: #f8f8f8">APN</span><span style="color: #000000;font-weight: bold">-&gt;</span><span style="background-color: #f8f8f8">getNumOperands</span><span style="background-color: #f8f8f8">()</span> <span style="color: #000000;font-weight: bold">==</span> <span style="background-color: #f8f8f8">NewPHINumOperands</span><span style="background-color: #f8f8f8">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: 正常情况下 pred 到 BB 为什么会有多条边
TODO: 疑惑，直觉上来讲，新增的 φ-node 的 <code>getNumOperands</code> 应该就是 0，那么直接用 0 就好了，为啥还要进行一次调用？</p>
</div>
<div class="paragraph">
<p>处理完 φ-node 后，就是替换 load 和 store 的部分，这里很直观，跟我们自己实现的差不多，就不再赘述了。</p>
</div>
<div class="paragraph">
<p>最后是“递归”的部分。首先将 BB 和 Pred 都更新为第一个 succ，然后将其他的后继 BB 都添加到 work list 中（这一步要跟外面的 while 循环配合才能完成使命），最后，跳回 <code>RenamePass</code> 的开始。本质上完成了一个先序 DFS 遍历。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">递归转迭代</div>
<div class="paragraph">
<p>我们只讨论直接递归（关于直接递归和间接递归，参见 <a href="https://www.baeldung.com/cs/recursion-direct-vs-indirect">Recursion: Direct vs Indirect</a>）。首先明确一点，递归的轨迹是一棵树（自然，可以退化成线性序列），这样我们讨论的问题就变成了如何将递归的树遍历算法转换为迭代形式。通常，遍历一棵树有三种形式：先序遍历、后序遍历和中序遍历，其中中序遍历是针对二叉树的特殊情况。</p>
</div>
<div class="paragraph">
<p>先来看先序遍历。LLVM 已经为我们做出了示范：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>将参数打包，保存在一个数据结构中</p>
</li>
<li>
<p>无限循环，通过 break 或者 return 结束</p>
</li>
<li>
<p>在循环的末尾设置好下一次“递归”的“参数”，将其他的部分保存起来</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>至于中序和后序，我也暂时没弄明白，尬笑……</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_总结">总结</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本文首先介绍了引入 mem2reg 的<a href="#sec:background">背景</a>，然后展示了若干简单的<a href="#sec:experiment">实验</a>加深对 mem2reg 功能的理解，接下来讲解了<a href="#sec:writing-mem2reg">如何实现自己的 mem2reg</a>，最后，本文详细地讲解了 <a href="#sec:reading-llvm-mem2reg">LLVM 的实现</a>。</p>
</div>
<div class="paragraph">
<p>总体而言，mem2reg 是 LLVM 中一个比较简单的 pass，不过通过学习这个 pass，我们了解了不少思想、相关的实现技术和需要注意的细节。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_参考">参考</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="bib:opt-no-effect"></a>[1] <a href="https://stackoverflow.com/questions/46513801/llvm-opt-mem2reg-has-no-effect">LLVM opt mem2reg has no effect</a></p>
</li>
<li>
<p><a id="bib:writing-an-llvm-pass-new-pm"></a>[2] <a href="https://llvm.org/docs/WritingAnLLVMNewPMPass.html">Writing an LLVM Pass (with the new pass manager)</a></p>
</li>
<li>
<p><a id="bib:llvm-progman"></a>[3] <a href="https://llvm.org/docs/ProgrammersManual.html:">LLVM Programmer’s Manual</a></p>
</li>
<li>
<p><a id="bib:llvm-langref"></a>[4] <a href="https://llvm.org/docs/LangRef.html">LLVM Language Reference</a></p>
</li>
<li>
<p><a id="bib:c11-annex-j.2"></a>[5] <a href="http://port70.net/~nsz/c/c11/n1570.html#J.2">J.2 Undefined behavior</a></p>
</li>
<li>
<p><a id="bib:llvm-langref-volatile"></a>[6] <a href="https://llvm.org/docs/LangRef.html#volatile-memory-accesses">Volatile Memory Accesses</a></p>
</li>
<li>
<p><a id="bib:liveness-analysis"></a>[7] <a href="https://en.wikipedia.org/wiki/Live-variable_analysis">Live-variable analysis - Wikipedia</a></p>
</li>
</ul>
</div>
</div>
</div>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/posts/compilers/tips/construct-lists-in-bison/" aria-label="上一页 - 在 Bison 中如何构造列表" class="btn btn-primary"><span class="mr-1">←</span>上一页</a>
  </li>
  <li>
    <a href="/posts/compilers/opt/llvm-passes/writing-an-llvm-pass/" aria-label="下一页 - 实现一个 LLVM Pass" class="btn btn-primary">下一页<span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="E-mail" aria-label="E-mail">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:my@rhanqtl.com" aria-label="E-mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https:/github.com/rhanqtl" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://twitter.com/rhanqtl" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2023 rhanqtl 保留所有权利</small>
        
	
		<p class="mt-2"><a href="/about/">个人简历</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
  <script src="/js/main.min.be25a680a0d95dc8b5d6664622e2134aa894220e2f224ef609e00f633a3a1b32.js" integrity="sha256-viWmgKDZXci11mZGIuITSqiUIg4vIk72CeAPYzo6GzI=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>